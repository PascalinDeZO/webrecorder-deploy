{% extends 'nginx.conf.j2' %}
{% block http_begin %}

geo $greylist {
   default 1;

   # CIDR in the list below are not limited
   {% for grey_ip in wr_ratelimit_exclude %}
   {{ grey_ip }} 0;
   {% endfor %}
}

map $greylist $limit {
    0     $binary_remote_addr;
    1     "";
}

limit_req_zone     $limit    zone=req_limit:50m rate=50r/s;
limit_req_status   503;

limit_conn_zone    $limit    zone=conn_limit:50m;
limit_conn_status  503;

{% endblock %}

